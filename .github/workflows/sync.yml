name: Sync with upstream

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        with:
          script: |
            const repo = context.repo.repo;
            const owner = context.repo.owner;
            const branch = "main";
            const fullName = `${owner}/${repo}`;

            async function notify(text) {
              const token = process.env.TELEGRAM_BOT_TOKEN;
              const chatId = process.env.TELEGRAM_CHAT_ID;
              if (!token || !chatId) {
                core.warning("Telegram secrets not configured — skipping notification.");
                return;
              }
              const res = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ chat_id: chatId, text, parse_mode: "HTML" }),
              });
              if (!res.ok) {
                const body = await res.text();
                core.warning(`Telegram failed (${res.status}): ${body}`);
              } else {
                core.info("Telegram notification sent.");
              }
            }

            function esc(s) {
              return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            }

            try {
              core.info(`Syncing ${fullName} (branch: ${branch}) with upstream...`);

              const { data } = await github.request(
                "POST /repos/{owner}/{repo}/merge-upstream",
                { owner, repo, branch },
              );

              if (data.merge_type === "none") {
                core.info("Already up to date.");
              } else {
                core.info(`Synced via ${data.merge_type}.`);
              }
            } catch (err) {
              if (err.status === 409) {
                core.setFailed("Merge conflict detected!");
                await notify(
                  `⚠️ <b>Merge conflict</b>\n\n` +
                  `Repo: <code>${fullName}</code>\n` +
                  `Branch: <code>${branch}</code>\n\n` +
                  `Upstream has changes that conflict with your fork.\n` +
                  `Resolve manually: https://github.com/${fullName}`,
                );
              } else {
                core.setFailed(`Sync failed (${err.status ?? "unknown"}): ${err.message}`);
                await notify(
                  `❌ <b>Sync error</b>\n\n` +
                  `Repo: <code>${fullName}</code>\n` +
                  `Branch: <code>${branch}</code>\n` +
                  `Error: <code>${esc(err.message)}</code>`,
                );
              }
            }
